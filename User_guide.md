# pUniFind: Unified large pretrained deep learning model pushing the limit of mass spectra interpretation

<!-- [![PyPI Version](https://img.shields.io/pypi/v/modelname)](https://pypi.org/project/modelname/)
[![License](https://img.shields.io/badge/License-Apache_2.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)
[![Colab Demo](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/your-repo) -->

This is the official repository for **pUniFind**, the most powerful zero-shot open peptide-spectrum scoring model surpassing other SOTA search engines and the first zero-shot open de novo sequencing deep learning model supporting over 1300 modifications. Developed by [pFind group](https://pfind.net/) and [DP Technology](https://www.dp.tech/en). We will release our arxiv preprint very soon.

## üìö Table of Contents
- [üöÄ Quick Start](#-quick-start)
- [üìä Output Formats](#-output-formats)
- [üìà Result visualization](#-result-vis)
- [üîß Advanced Configuration Options](#-configuration-options)
- [üß† Take care](#-take-care)
- [üõ†Ô∏è Technical Support](#-technical-support)
- [‚ùì FAQ](#-faq)
- [ü§ù Citation](#-citation)

## üöÄ Quick Start <a name="-quick-start"></a>

Demo data can be downloaded from [Google Drive](https://drive.google.com/drive/folders/1CQzNypmOscCpvyK3MnCj4AhEWGlx9mbn?usp=sharing).

### Local deployment for Windows
Running our model on windows requires gpu. Dear reviewers, you can use ```xzhbez6w``` as your Bohrium ID, which can help you avoid registering a Bohrium account. Ordinary users are required to register a free Bohrium ID to add users.

Down load the ```.exe``` install package first and then install by following the instructions.

For ```GPU Batch size```, you can set it to 128 if your GPU has more than 24GB memory. If your GPU only has around 4GB memory, consider setting it to 64. You can use the ```nvidia-smi``` command in your terminal to check your GPU's memory information.


The rescoring results will be saved in the ```result``` folder. The de novo sequencing results will be stored in the ```pUniFind_result``` folder.


### Local deployment for Linux (Will be released soon)
#### Env setup
Our pUniFind support multi-gpu processing to speed up.

| env | version |
| :---: | ---: |
| cuda | >= 11.7 |
| python | 3.8 |


```bash
# set up conda env
conda create -n pUniFind python=3.8 -y
conda activate pUniFind

# get to project path
cd Contrast_MS_Pep
bash env.sh
```

#### Open Rescore
Put the following folder to ```official_projects```.
```bash
project_name/ # pFind Task folder generated by pfind !!!!!!
‚îú‚îÄ‚îÄ param/ # pFind search parameters (generated by pfind)
‚îú‚îÄ‚îÄ result/ # pFind search result (generated by pfind)
‚îÇ   ‚îî‚îÄ‚îÄ ***.pac # protein ids (generated by pfind at fasta folder moved by users)
‚îî‚îÄ‚îÄ mgfs/ # mgf files (generated by pfind moved by users)
```

Then do rescoring by this:
```bash
bash official_score_workflow.sh project_name batchsize
```
We recommand a batchsize of 256 at first and adjust this by seeing speed and cuda memory size.
- Results will be stored at ```project_namefdr0.01_pUniFind.spectra```.

#### Open De Novo
Put the following folder to ```official_projects```.

```bash
project_name/ 
‚îî‚îÄ‚îÄ mgfs/ # mgf files (generated by pfind moved by users)   
```

Then do open de novo by this:
```bash
bash official_denovo_workflow.sh project_name batchsize
```
We recommand a batchsize of 256 at first and adjust this by seeing speed and cuda memory size.
- Direct de novo results will be stored at ```project_name_001_5_merged.csv``` and ```project_name_001_5_filtered.csv``` under ```pUniFind_result``` folder.

- Modification statistics will be stored at ```project_name_mod.txt``` under ```pUniFind_result``` folder.

- All peptides connected will be stored at ```project_name.fasta``` under ```pUniFind_result``` folder.

If you only cares about very **few modifications**, we recommend you further search pFind3 (with open mode disabled) use fasta file above and set modifications you care (considering ```project_name_mod.txt```) as variable modification. 

### Web application
If you do not have gpu. You can access our [Bohrium Web Interface](https://bohrium.dp.tech/apps/punifind) to rent gpu and run pUniFind online directly.

The gpu resource from bohrium can be unstable. If you can note get your job started, this is most likely result from lack of gpu resource. We recommend you try 4090 at first. If 4090 is not avilable, we recommend 3090.

If you have any problem, please contact us through **Technical Suport**. 

```bash
# Folder to upload

# Rescoring
pFind Task folder/ # generated by pfind
‚îú‚îÄ‚îÄ param/ # pFind search parameters (generated by pfind)
‚îú‚îÄ‚îÄ result/ # pFind search result (generated by pfind)
‚îÇ   ‚îî‚îÄ‚îÄ ***.pac # protein ids (generated by pfind at fasta folder moved by users)
‚îî‚îÄ‚îÄ mgfs/ # mgf files (generated by pfind moved by users)

# De novo sequencing
project folder/ 
‚îî‚îÄ‚îÄ mgfs/ # mgf files (generated by pfind moved by users)   

```

## üìä Output Formats <a name="-output-formats"></a>
### Open Rescore Results

| column name | meaning | example |
| :---: | :--- | --- |
| File_Name | Title of spectrum from mgf. | example.1.1.2.0.dta |
| Scan_No | Scan No. | 1000 |
| Charge | Charge | 1 |
| Sequence | Sequence identified by pUniFind | SPTCTNQEL |
| Calc_MHplus+ | MH+ mass | 2031.948724 |
| Modification | Modification | 4,Carbamidomethyl[C];8,Cation_Na[E]; |
| Proteins | Proteins | tr\|A0A075B6G3\|A0A075B6G3_HUMAN/ |


### Open De Novo Results
Currently, to improve performance, we only predict scores for peptides with a precursor mass error tolerance within 20 ppm and peptide lengths ranging from 6 to 40 residues. Predicted peptides outside of these ranges will not be logged. In future releases, we plan to support more flexible settings.

To better visualize result format we will show columns as rows with the same order.

#### For _merged.csv and _filtered.csv
| column name | meaning | example |
| :---: | :--- | --- |
| spectrum title | Title of spectrum from mgf. | example.1.1.2.0.dta |
| score | Score predicted by pUniFind, which is the same score as open rescoring. | 7.241 |
| cos similarity | Cos similarity between experiment spectrum and spectrum of de novo result peptide predicted by pUniFind | 0.95 |
| Retention time | Experimental retention time (seconds). | 1169.002807 |
| Missing fragment ion site | Position of Missing fragment ion site. The last number seperated by "_" is peptide length, ignore the last number. | 6_8 |
| mass difference | Mass difference between predicted peptide sequence and experiment precursor mass. | 0.0003662109375 |
| Peptide sequence | Peptide sequencing predicted | ['SPTCTNQEL'] |
| Peptide sequence with modification | Peptide sequencing predicted with modification and modification sites. | SPTCTNQEL_4_Carbamidomethyl_8_Cation_Na |
| Modifications | Modifications and sites predicted | "4,Carbamidomethyl[C];8,Cation_Na[E];" |

#### For .fasta
Just typical fasta file.

#### For _mod.txt

| column name | meaning | example |
| :---: | :--- | --- |
| Modification Name | Name of modification. | Oxidation[M] |
| Frequency of modification | Frequency appeared in topN candidates | 3296 |

## üîß Advanced Configuration Options <a name="-configuration-options"></a>
There are a few configurations to set in shell scripts(official_denovo_workflow.sh, official_score_workflow.sh), which may modify for your usage:
| Name | Usage |
| :---: | --- |
| num_proc | Number of cpu process during data process. This is particularly useful if there are a lot of mgfs. num_proc <= number of cpu cores (default=16) |
| range_pred | Number of candidates with different length to de novo. We will first predict the length of peptide and then predict peptides with multiple length. You should use odd number. (default=5) |
<!-- | fdr_thread(only in score) | FDR(by pFind) of spectrum below which will be inferenced and reranked. (default=0.1) | -->
In the future there will be more options supported, such as:
| Name | Usage |
| :---: | --- |
| de novo min/max length | Minimum or maximum length of peptide to be predicted. Since pUniFind first predict length and then predict peptide, if the length is not satisfied, peptide of corresponding spectrum will not be predicted to speed up. |
| predict_score_all | There are cases that all candidate peptide for a spectrum do not satisfy 20 ppm threashold. In current default mode, pUniFind will not predict the score for them to speedup. |
| instrument | Type of instrument, e.g. QE, Lumos, TIMS, Astral. For now, it is QE by default. |
| nce file path | Type of instrument. For now, it is 30 by default. |

## üìà Result visualization <a name="-result-vis"></a>
We provide user-friendly de novo result visualization tool for both workflow mentioned in our paper.

- Regular de novo: [pLabel](https://pfind.net/software/pLabel/index.html) is a convenient tool to visualize spectrum. pLabel requires a .plabel file and the corresponding .mgf file to do visualization. What user need to do is to change the path of mgf file in .plabel file (which is generated by pUniFind). User guide of pLabel can be seen in link above. **It is important to check that the mgf name and mgf path is correct!!**
```bash
# pLabel format example
[FilePath]
File_Path=C:\Users\Ecoli-E1-F2-20151208_HCDFT_extract103.mgf # path of mgf!!
[Modification]
1=Oxidation[M]
2=Carbamidomethyl[C]
[xlink]
xlink=NULL
[Total]
total=1
[Spectrum1]
name=ECOLI-E1-F2-20151208.30360.30360.3.0.DTA
pep1=0 LGLDVLVHGEAER 1 
```
- Modification rich de novo: This workflow rely on [pFind](https://pfind.net/software/pFind/index.html) (disable ```open``` mode) to do database (generated by pUniFind) search. pBuild is a visualization tool which is already integrated to pFind.

## üß† Take care <a name="-take-care"></a>
Open de novo sequencing is a very challenging and complicated task, there are a few things you should take care.
- There are a few "mass coincidences", some of them are :
```Q+Deamidated[Q]=E```, ```N+Deamidated[N]=D```, ```glycidamide[anything]=S```, ```Acetyl+K=AV/VA```,```K+Crotonyl=PV/VP```,```K+Formy=GV/VG```,```K+Ubiq=GG```,```G+Methyl=A```, etc. We do not recommend you to search these modifications in modification rich de novo workflow unless that kind modification is exactly what you want, in which case, you might want to postprocess searched result.
- There are a few loss modifications you might want to ignore:
```Arg-loss[AnyC-termR]```, ```Met-loss[ProteinN-termM]```, ```Met-loss+Acetyl[ProteinN-termM]```, etc.
- Currently, pUniFind do not support ITMS(considered to be outdated with low resolution) or ETD/EThcD data.


## üõ†Ô∏è Technical Support  <a name="-technical-support"></a>
Should you encounter any technical issues, observe suboptimal performance, or identify inconsistencies between pUniFind results and our evaluation metrics, we welcome your feedback üôè. We are looking for bad cases to further refine our model. We are **actively** updating and refining our software, since the main author is **far** from graduation :(.

We provide **priority support** for user-reported issues through the following channels:  

**For technical inquiries:**  
1. **GitHub Issues**: [Open a new issue](https://github.com/pFindStudio/pUniFind/issues) with:  
   - Data description.  
   - Error logs and environment.
   - Uploaded folder description  

1. **pFind Studio user support WeChat group**: 
   - Please add WeChat: ```JL_Zhao2000```, and I will invite you into our user support group. (Because WeChat invitation expire in one week.)

**For collaboration requests:**  
üìß **Contact info**:  Jiale Zhao. Email: [zhaojiale22z@ict.ac.cn](mailto:zhaojiale22z@ict.ac.cn) or [marshmallowzjl@gmail.com](mailto:marshmallowzjl@gmail.com).

## ‚ùì FAQ <a name="-faq"></a>

- If you met this ```libstdc++.so.6: version `GLIBCXX_3.4.29' not found``` problem, see [This Solution](https://github.com/pybind/pybind11/discussions/3453). In my case, I solved this by ```export LD_LIBRARY_PATH=/your_path/miniconda3/envs/pUniFind/lib:$LD_LIBRARY_PATH```.

- If you can not get result file for rescoring. please see if you put ```.pac``` file at the right place.

## ü§ù Citation <a name="-citation"></a>
If you find our software is useful and helped your research,  **please cite** us üôè through:
```bash
Wating
```
Every citation of yours will motivate the main author to make pUniFind more user-friendly and more powerful. Main author need your valuable citations and stars to find a job after graduation üò´.


